<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="alerts.title">Alertas de Seguridad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/alertas.css">
    <link rel="stylesheet" href="css/alertas-map.css">
    <script src="js/i18n-browser.js"></script>
</head>
<body class="bg-gray-900 bg-pattern text-white">

    <!-- Header / Navegación -->
    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-700">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/home.html" class="text-2xl font-bold text-white">Rutopia</a>
            <div class="hidden md:flex items-center space-x-8">
                <a href="/home.html" class="text-gray-300 hover:text-indigo-400 transition" data-i18n="navigation.home">Inicio</a>
                <a href="/alertas.html" class="text-indigo-400 font-semibold" data-i18n="navigation.alerts">Alertas</a>
                <a href="/itinerario.html" class="text-gray-300 hover:text-indigo-400 transition" data-i18n="navigation.itinerary">Itinerario</a>
                <a href="/recomendaciones.html" class="text-gray-300 hover:text-indigo-400 transition" data-i18n="navigation.destinations">Destinos</a>
                <a href="/historial.html" class="text-gray-300 hover:text-indigo-400 transition" data-i18n="navigation.history">Historial</a>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Selector de idioma -->
                <div class="language-selector">
                    <select id="languageSelector" class="px-3 py-1 border border-gray-600 bg-gray-700 text-white rounded-lg text-sm">
                        <option value="es">🇪🇸 Español</option>
                        <option value="en">🇺🇸 English</option>
                    </select>
                </div>
                
                <div class="relative">
                    <button id="profile-button" class="flex items-center space-x-2">
                        <img src="https://placehold.co/40x40/1f2937/a78bfa?text=U" alt="Avatar de usuario" class="w-10 h-10 rounded-full border-2 border-indigo-400">
                    </button>
                    <div id="profile-menu" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl py-2 z-50 border border-gray-700">
                        <a href="/profile.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-i18n="navigation.profile">Mi Perfil</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-i18n="navigation.settings">Configuración</a>
                        <div class="border-t border-gray-700 my-1"></div>
                        <a href="#" id="logout-link" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-i18n="navigation.logout">Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Contenido Principal -->
    <main class="container mx-auto px-6 py-12">

        <!-- Sección Hero -->
        <section class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-bold mb-4">
                <span data-i18n="alerts.title">Alertas de</span> <span class="text-red-400" data-i18n="alerts.titleHighlight">Seguridad</span>
            </h1>
            <p class="text-gray-300 text-lg max-w-2xl mx-auto mb-8" data-i18n="alerts.subtitle">
                Mantente informado sobre zonas con problemas de tráfico, fenómenos naturales o situaciones de seguridad en tiempo real.
            </p>
        </section>

        <!-- Configuración de Notificaciones -->
        <section class="mb-12">
            <div class="bg-gray-800/50 border border-gray-700 rounded-2xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-2" data-i18n="alerts.notificationSettings">Configuración de Notificaciones</h2>
                        <p class="text-gray-400" data-i18n="alerts.notificationDesc">Activa o desactiva las alertas según tus preferencias</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-400" data-i18n="alerts.notifications">Notificaciones</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notifications-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold" data-i18n="alerts.traffic">Tráfico</h3>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="traffic-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p class="text-sm text-gray-400" data-i18n="alerts.trafficDesc">Alertas sobre congestiones viales y accidentes</p>
                        <div class="mt-2">
                            <span id="traffic-status" class="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400" data-i18n="alerts.active">Activo</span>
                        </div>
                    </div>
                    
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold" data-i18n="alerts.naturalPhenomena">Fenómenos Naturales</h3>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="natural-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p class="text-sm text-gray-400" data-i18n="alerts.naturalDesc">Alertas sobre terremotos, huracanes, etc.</p>
                        <div class="mt-2">
                            <span id="natural-status" class="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400" data-i18n="alerts.active">Activo</span>
                        </div>
                    </div>
                    
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold" data-i18n="alerts.security">Seguridad</h3>
                            <label class="toggle-switch small">
                                <input type="checkbox" id="security-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p class="text-sm text-gray-400" data-i18n="alerts.securityDesc">Alertas sobre zonas de riesgo</p>
                        <div class="mt-2">
                            <span id="security-status" class="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400" data-i18n="alerts.active">Activo</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Alertas Activas -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold mb-8" data-i18n="alerts.recentAlertsTitle">Alertas Activas</h2>
            <div id="alertas-container" class="space-y-4">
                <!-- Las alertas se cargarán dinámicamente aquí -->
            </div>
        </section>

        <!-- Mapa de Zonas -->
        <section>
            <h2 class="text-3xl font-bold mb-8" data-i18n="alerts.mapTitle">Mapa de Zonas de Alerta</h2>
            <div class="bg-gray-800/50 border border-gray-700 rounded-2xl p-8">
                <!-- Controles de filtro -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4" data-i18n="alerts.filterAlerts">Filtrar Alertas</h3>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="filter-traffic" checked class="rounded border-gray-600 bg-gray-700 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-gray-300" data-i18n="alerts.trafficFilter">🚗 Tráfico</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="filter-natural" checked class="rounded border-gray-600 bg-gray-700 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-gray-300" data-i18n="alerts.naturalFilter">🌊 Fenómenos Naturales</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="filter-security" checked class="rounded border-gray-600 bg-gray-700 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-sm text-gray-300" data-i18n="alerts.securityFilter">⚠️ Seguridad</span>
                        </label>
                    </div>
                </div>
                
                <!-- Contenedor del mapa -->
                <div class="relative">
                    <div id="alertas-map" class="alertas-map-container bg-gray-700 rounded-lg">
                        <!-- El mapa se cargará aquí -->
                    </div>
                    
                    <!-- Botón para centrar en ubicación actual -->
                    <button id="btn-mi-ubicacion" class="btn-actualizar-ubicacion" data-i18n="alerts.myLocation" title="Ir a mi ubicación">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Información adicional -->
                <div class="mt-6 space-y-4">
                    <!-- Leyenda de colores -->
                    <div class="bg-gray-700/50 rounded-lg p-4">
                        <h4 class="text-sm font-semibold mb-3 text-gray-200" data-i18n="alerts.severityLegend">Leyenda de Colores por Severidad</h4>
                        <div class="grid grid-cols-3 gap-4 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-red-600 rounded-full border border-red-400"></div>
                                <span class="text-gray-300" data-i18n="alerts.high">Alta - Crítico</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-orange-500 rounded-full border border-orange-400"></div>
                                <span class="text-gray-300" data-i18n="alerts.medium">Media - Moderado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-500 rounded-full border border-green-400"></div>
                                <span class="text-gray-300" data-i18n="alerts.low">Baja - Leve</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información de tipos -->
                    <div class="grid md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">🚗</span>
                                <span class="font-medium" data-i18n="alerts.traffic">Tráfico</span>
                            </div>
                            <p class="text-gray-400" data-i18n="alerts.trafficInfo">Congestiones, accidentes y cierres viales</p>
                        </div>
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">🌊</span>
                                <span class="font-medium" data-i18n="alerts.naturalPhenomena">Fenómenos Naturales</span>
                            </div>
                            <p class="text-gray-400" data-i18n="alerts.naturalInfo">Sismos, lluvias intensas e inundaciones</p>
                        </div>
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg">⚠️</span>
                                <span class="font-medium" data-i18n="alerts.security">Seguridad</span>
                            </div>
                            <p class="text-gray-400" data-i18n="alerts.securityInfo">Zonas de riesgo y actividad sospechosa</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-700 mt-20">
        <div class="container mx-auto px-6 py-8 text-center text-gray-400">
            <p>&copy; 2025 Rutopia. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script type="module">
        import { auth, db } from '/src/firebase.js'
        import { onAuthStateChanged, signOut } from 'firebase/auth'
        import { doc, getDoc, setDoc } from 'firebase/firestore'

        const profileButton = document.getElementById('profile-button')
        const profileMenu = document.getElementById('profile-menu')
        const logoutLink = document.getElementById('logout-link')
        const notificationsToggle = document.getElementById('notifications-toggle')
        const trafficToggle = document.getElementById('traffic-toggle')
        const naturalToggle = document.getElementById('natural-toggle')
        const securityToggle = document.getElementById('security-toggle')
        const alertasContainer = document.getElementById('alertas-container')
        const trafficStatus = document.getElementById('traffic-status')
        const naturalStatus = document.getElementById('natural-status')
        const securityStatus = document.getElementById('security-status')

        let currentUser = null

        // Datos de ejemplo para las alertas
        const alertasEjemplo = [
            {
                id: 1,
                tipo: 'traffic',
                titulo: 'Congestión Vial',
                ubicacion: 'Centro Histórico, CDMX',
                descripcion: 'Tráfico pesado en Av. Juárez debido a manifestación',
                severidad: 'media',
                tiempo: 'Hace 15 min'
            },
            {
                id: 2,
                tipo: 'natural',
                titulo: 'Alerta Sísmica',
                ubicacion: 'Zona Metropolitana',
                descripcion: 'Sismo de 4.2 grados detectado en la región',
                severidad: 'alta',
                tiempo: 'Hace 5 min'
            },
            {
                id: 3,
                tipo: 'security',
                titulo: 'Zona de Riesgo',
                ubicacion: 'Tepito, CDMX',
                descripcion: 'Reportes de actividad sospechosa en la zona',
                severidad: 'alta',
                tiempo: 'Hace 30 min'
            }
        ]

        function getSeveridadColor(severidad) {
            switch(severidad) {
                case 'baja': return 'bg-green-500'
                case 'media': return 'bg-yellow-500'
                case 'alta': return 'bg-red-500'
                default: return 'bg-gray-500'
            }
        }

        function getTipoIcon(tipo) {
            switch(tipo) {
                case 'traffic':
                    return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>`
                case 'natural':
                    return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>`
                case 'security':
                    return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>`
                default:
                    return `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`
            }
        }

        function renderAlertas() {
            alertasContainer.innerHTML = ''
            
            alertasEjemplo.forEach(alerta => {
                const alertaElement = document.createElement('div')
                alertaElement.className = 'bg-gray-800/50 border border-gray-700 rounded-lg p-6 card-hover'
                alertaElement.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 bg-gray-700 rounded-lg flex items-center justify-center">
                                    ${getTipoIcon(alerta.tipo)}
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h3 class="text-lg font-semibold">${alerta.titulo}</h3>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${getSeveridadColor(alerta.severidad)}">
                                        ${alerta.severidad.toUpperCase()}
                                    </span>
                                </div>
                                <p class="text-gray-400 mb-2">${alerta.ubicacion}</p>
                                <p class="text-gray-300">${alerta.descripcion}</p>
                                <p class="text-sm text-gray-500 mt-3">${alerta.tiempo}</p>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-white transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `
                alertasContainer.appendChild(alertaElement)
            })
        }

        // Si no hay usuario autenticado, regresar al login
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = '/login.html'
                return
            }
            currentUser = user
            
            // Cargar configuración guardada
            loadAlertSettings(user.uid)
            
            // Renderizar alertas
            renderAlertas()
            
            // Inicializar el mapa
            initializeMap()
            
            // Inicializar indicadores de estado
            updateStatusIndicators()
        })

        profileButton.addEventListener('click', () => {
            profileMenu.classList.toggle('hidden')
        })

        // Cerrar el menú al hacer click fuera
        window.addEventListener('click', (e) => {
            if (!profileButton.contains(e.target) && !profileMenu.contains(e.target)) {
                profileMenu.classList.add('hidden')
            }
        })

        // Cerrar sesión
        logoutLink.addEventListener('click', async (e) => {
            e.preventDefault()
            try {
                await signOut(auth)
                window.location.href = '/login.html'
            } catch (err) {
                console.error('Error al cerrar sesión', err)
            }
        })

        // Event listeners para los toggles
        notificationsToggle.addEventListener('change', () => {
            updateToggleVisualState()
            updateStatusIndicators()
            saveAlertSettings()
        })

        trafficToggle.addEventListener('change', () => {
            updateToggleVisualState()
            updateStatusIndicators()
            saveAlertSettings()
        })

        naturalToggle.addEventListener('change', () => {
            updateToggleVisualState()
            updateStatusIndicators()
            saveAlertSettings()
        })

        securityToggle.addEventListener('change', () => {
            updateToggleVisualState()
            updateStatusIndicators()
            saveAlertSettings()
        })

        // Función para actualizar el estado visual de los toggles
        function updateToggleVisualState() {
            // Forzar la actualización visual de los toggles
            const toggles = [notificationsToggle, trafficToggle, naturalToggle, securityToggle]
            toggles.forEach(toggle => {
                // Trigger reflow para forzar la actualización visual
                toggle.style.display = 'none'
                toggle.offsetHeight // Trigger reflow
                toggle.style.display = ''
            })
        }

        // Función para actualizar los indicadores de estado
        function updateStatusIndicators() {
            // Actualizar indicador de tráfico
            if (trafficStatus) {
                if (trafficToggle.checked) {
                    trafficStatus.textContent = 'Activo'
                    trafficStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400'
                } else {
                    trafficStatus.textContent = 'Inactivo'
                    trafficStatus.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400'
                }
            }

            // Actualizar indicador de fenómenos naturales
            if (naturalStatus) {
                if (naturalToggle.checked) {
                    naturalStatus.textContent = 'Activo'
                    naturalStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400'
                } else {
                    naturalStatus.textContent = 'Inactivo'
                    naturalStatus.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400'
                }
            }

            // Actualizar indicador de seguridad
            if (securityStatus) {
                if (securityToggle.checked) {
                    securityStatus.textContent = 'Activo'
                    securityStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400'
                } else {
                    securityStatus.textContent = 'Inactivo'
                    securityStatus.className = 'text-xs px-2 py-1 rounded-full bg-red-500/20 text-red-400'
                }
            }
        }

        async function loadAlertSettings(uid) {
            try {
                const ref = doc(db, 'alertSettings', uid)
                const snap = await getDoc(ref)
                if (snap.exists()) {
                    const settings = snap.data()
                    notificationsToggle.checked = settings.notificationsEnabled ?? true
                    trafficToggle.checked = settings.trafficEnabled ?? true
                    naturalToggle.checked = settings.naturalEnabled ?? true
                    securityToggle.checked = settings.securityEnabled ?? true
                }
                // Actualizar el estado visual después de cargar
                updateToggleVisualState()
                updateStatusIndicators()
            } catch (err) {
                console.error('Error al cargar configuración de alertas', err)
            }
        }

        async function saveAlertSettings() {
            if (!currentUser) return
            
            try {
                const settings = {
                    notificationsEnabled: notificationsToggle.checked,
                    trafficEnabled: trafficToggle.checked,
                    naturalEnabled: naturalToggle.checked,
                    securityEnabled: securityToggle.checked,
                    updatedAt: new Date().toISOString()
                }
                
                await setDoc(doc(db, 'alertSettings', currentUser.uid), settings, { merge: true })
                console.log('Configuración de alertas guardada')
                
                // Mostrar mensaje de confirmación temporal
                showNotification('Configuración guardada correctamente')
            } catch (err) {
                console.error('Error al guardar configuración de alertas', err)
                showNotification('Error al guardar configuración', 'error')
            }
        }

        // Función para mostrar notificaciones
        function showNotification(message, type = 'success') {
            // Crear elemento de notificación
            const notification = document.createElement('div')
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`
            notification.textContent = message
            
            // Agregar al DOM
            document.body.appendChild(notification)
            
            // Animar entrada
            setTimeout(() => {
                notification.classList.remove('translate-x-full')
            }, 100)
            
            // Remover después de 3 segundos
            setTimeout(() => {
                notification.classList.add('translate-x-full')
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification)
                    }
                }, 300)
            }, 3000)
        }

        // Inicialización del mapa cuando el usuario está autenticado
        async function initializeMap() {
            try {
                const { default: AlertasMap } = await import('/js/alertas-map.js');
                
                // Crear instancia del mapa
                const alertasMap = new AlertasMap('alertas-map');
                
                // Configurar filtros
                const filterTraffic = document.getElementById('filter-traffic');
                const filterNatural = document.getElementById('filter-natural');
                const filterSecurity = document.getElementById('filter-security');
                const btnMiUbicacion = document.getElementById('btn-mi-ubicacion');
                
                // Función para aplicar filtros
                function aplicarFiltros() {
                    const tiposActivos = [];
                    if (filterTraffic.checked) tiposActivos.push('traffic');
                    if (filterNatural.checked) tiposActivos.push('natural');
                    if (filterSecurity.checked) tiposActivos.push('security');
                    
                    alertasMap.filtrarPorTipo(tiposActivos);
                }
                
                // Eventos de filtros
                filterTraffic.addEventListener('change', aplicarFiltros);
                filterNatural.addEventListener('change', aplicarFiltros);
                filterSecurity.addEventListener('change', aplicarFiltros);
                
                // Botón de ubicación actual
                btnMiUbicacion.addEventListener('click', () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const coords = [
                                    position.coords.longitude,
                                    position.coords.latitude
                                ];
                                alertasMap.centrarEn(coords, 15);
                            },
                            (error) => {
                                console.error('Error obteniendo ubicación:', error);
                                showNotification('No se pudo obtener tu ubicación', 'error');
                            }
                        );
                    } else {
                        showNotification('Geolocalización no soportada', 'error');
                    }
                });
                
                console.log('Mapa de alertas inicializado correctamente');
                
            } catch (error) {
                console.error('Error inicializando el mapa:', error);
                
                // Mostrar mensaje de error en el contenedor del mapa
                const mapContainer = document.getElementById('alertas-map');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <svg class="w-16 h-16 text-gray-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <p class="text-gray-400">Error cargando el mapa</p>
                                <p class="text-sm text-gray-500 mt-2">Verifica la configuración de Mapbox</p>
                            </div>
                        </div>
                    `;
                }
            }
        }
    </script>

    <!-- Inicialización de i18n -->
    <script>
        // Inicializar traducciones cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar el selector de idioma
            i18n.initLanguageSelector();
            
            // Aplicar traducciones iniciales después de un pequeño delay
            // para asegurar que las traducciones estén cargadas
            setTimeout(() => {
                i18n.translatePage();
            }, 100);
        });
    </script>

</body>
</html> 