<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil - Rutopia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .bg-pattern { background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); background-color: #111827; }
  </style>
</head>
<body class="bg-gray-900 bg-pattern text-white">
  <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-gray-700">
    <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
      <a href="/" class="text-2xl font-bold text-white">Rutopia</a>
      <a href="/home.html" class="text-indigo-400 hover:text-indigo-300">Ir a Home</a>
    </nav>
  </header>

  <main class="container mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-6">Mi Perfil</h1>
    <div class="bg-gray-800/50 border border-gray-700 rounded-2xl p-8">
      <form id="prefs-form" class="grid md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm text-gray-300 mb-2">Tipo de hospedaje favorito</label>
          <select id="stayType" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white">
            <option value="hotel">Hotel</option>
            <option value="hostal">Hostal</option>
            <option value="cabaña">Cabaña</option>
            <option value="departamento">Departamento</option>
            <option value="resort">Resort</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Ubicación preferida</label>
          <select id="location" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white">
            <option value="montaña">Montaña</option>
            <option value="playa">Playa</option>
            <option value="ciudad">Ciudad</option>
            <option value="campo">Campo</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Lugares de interés</label>
          <input id="interests" type="text" placeholder="Ej: museos, hiking, comida" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400">
          <p class="text-xs text-gray-400 mt-2">Usa comas para separar múltiples intereses.</p>
        </div>
        <div>
          <label class="block text-sm text-gray-300 mb-2">Compañía de viaje</label>
          <select id="company" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white">
            <option value="solo">Solo</option>
            <option value="pareja">Pareja</option>
            <option value="familia">Familia</option>
            <option value="amigos">Amigos</option>
            <option value="grupo">Grupo</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-300 mb-2">Etiquetas de preferencias</label>
          <div class="flex flex-wrap gap-3 mb-3" id="tags-choices"></div>
          <button type="button" id="addTagBtn" class="bg-gray-700 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Añadir etiqueta</button>
        </div>
        <div class="md:col-span-2">
          <button id="saveBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg" disabled>Guardar preferencias</button>
          <span id="saveStatus" class="text-sm text-gray-400 ml-4"></span>
        </div>
      </form>
    </div>
  </main>

  <script type="module">
    import { auth, db } from '/src/firebase.js'
    import { onAuthStateChanged } from 'firebase/auth'
    import { doc, getDoc, setDoc } from 'firebase/firestore'

    const url = new URL(window.location.href)
    const isFirst = url.searchParams.get('first') === '1'
    let currentUser = null
    let tags = []

    const form = document.getElementById('prefs-form')
    const stayTypeEl = document.getElementById('stayType')
    const locationEl = document.getElementById('location')
    const interestsEl = document.getElementById('interests')
    const companyEl = document.getElementById('company')
    const tagsChoicesEl = document.getElementById('tags-choices')
    const addTagBtn = document.getElementById('addTagBtn')
    const saveStatusEl = document.getElementById('saveStatus')
    const saveBtn = document.getElementById('saveBtn')

    function clearElement(el) { while (el && el.firstChild) el.removeChild(el.firstChild) }
    function renderTags() {
      clearElement(tagsChoicesEl)
      tags.forEach((t, i) => {
        const span = document.createElement('span')
        span.className = 'flex items-center bg-gray-700 text-white py-2 px-4 rounded-full'
        const text = document.createElement('span')
        text.textContent = t
        const btn = document.createElement('button')
        btn.textContent = '×'
        btn.className = 'ml-3 text-gray-300 hover:text-white'
        btn.addEventListener('click', () => {
          tags.splice(i, 1)
          renderTags()
        })
        span.appendChild(text)
        span.appendChild(btn)
        tagsChoicesEl.appendChild(span)
      })
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = '/'
        return
      }
      currentUser = user
      saveBtn.disabled = false
      await load()
    })

    async function load() {
      try {
        const ref = doc(db, 'profiles', currentUser.uid)
        const snap = await getDoc(ref)
        if (snap.exists()) {
          const p = snap.data()
          if (p.stayType) stayTypeEl.value = p.stayType
          if (p.location) locationEl.value = p.location
          if (p.interests && Array.isArray(p.interests)) interestsEl.value = p.interests.join(', ')
          if (p.company) companyEl.value = p.company
          tags = Array.isArray(p.tags) ? p.tags : []
        }
        renderTags()
      } catch (err) {
        console.error('No se pudieron cargar las preferencias', err)
      }
    }

    addTagBtn.addEventListener('click', () => {
      const value = prompt('Nueva etiqueta (ej: Montaña, Aventura, Cultura)')
      if (!value) return
      const t = value.trim()
      if (!t || tags.includes(t)) return
      tags.push(t)
      renderTags()
    })

    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      const payload = {
        stayType: stayTypeEl.value,
        location: locationEl.value,
        interests: interestsEl.value.split(',').map(s => s.trim()).filter(Boolean),
        company: companyEl.value,
        tags,
        updatedAt: new Date().toISOString(),
      }
      try {
        await setDoc(doc(db, 'profiles', currentUser.uid), payload, { merge: true })
        try { sessionStorage.setItem('rutopia_prefs', JSON.stringify(payload)) } catch (_) {}
        saveStatusEl.textContent = 'Preferencias guardadas'
        try { alert('Preferencias guardadas correctamente') } catch (_) {}
        setTimeout(() => saveStatusEl.textContent = '', 2500)
        // Redirige siempre a home tras guardar
        window.location.href = '/home.html'
      } catch (err) {
        saveStatusEl.textContent = 'Error al guardar. Revisa la consola.'
        console.error('Error al guardar preferencias', err)
      }
    })
  </script>
</body>
</html>



